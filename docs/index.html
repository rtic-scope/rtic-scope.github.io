<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-07-24 Sat 00:12 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>RTIC Scope</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Viktor Vilhelm Sonesten" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">RTIC Scope</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgadd38ad">1. About</a>
<ul>
<li><a href="#org23255d2">1.1. Features</a></li>
<li><a href="#org5995860">1.2. Project repositories/crates</a></li>
</ul>
</li>
<li><a href="#orgd01f69e">2. Requirements</a>
<ul>
<li><a href="#org4803f03">2.1. Hardware</a></li>
<li><a href="#org003680d">2.2. Software</a></li>
</ul>
</li>
<li><a href="#org09be389">3. Getting started</a>
<ul>
<li><a href="#org718b105">3.1. Examples</a>
<ul>
<li><a href="#org25b2532">3.1.1. blinky</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgd283a18">4. Concepts</a></li>
<li><a href="#org734dc17">5. How it works</a>
<ul>
<li><a href="#org8d2d853">5.1. The ITM/DWT subsystem</a></li>
<li><a href="#orgc999d7b">5.2. Host-side information recovery</a></li>
</ul>
</li>
<li><a href="#org9ce4b4a">6. Limitations</a>
<ul>
<li><a href="#org9a06bec">6.1. Dropped ITM packets</a></li>
<li><a href="#orge366da9">6.2. RTIC application constrains</a></li>
<li><a href="#orgc0e924f">6.3. Target-side overhead</a></li>
</ul>
</li>
<li><a href="#orgc6d88e7">7. Frequently asked questions</a></li>
<li><a href="#orgcdb179d">8. Roadmap</a></li>
<li><a href="#orgc79ca6f">9. Known issues (of note)</a></li>
<li><a href="#org11b152c">10. Publications</a></li>
<li><a href="#org55797e3">11. License</a></li>
<li><a href="#orgdb876a4">12. Contact, bug reports and contributions</a></li>
</ul>
</div>
</div>
<p>
<b>NOTE:</b> RTIC Scope and this document are works in progress.
</p>

<hr />

<div id="outline-container-orgadd38ad" class="outline-2">
<h2 id="orgadd38ad"><span class="section-number-2">1</span> About</h2>
<div class="outline-text-2" id="text-1">
<p>
<b>RTIC Scope</b> is a zero-overhead framework for recording and analyzing execution traces from <a href="https://rtic.rs">RTIC applications</a> on ARMv7-M targets.
The lack of overhead is achieved by exploiting the ITM/DWT subsystem as defined by the <a href="https://developer.arm.com/documentation/ddi0403/ed/">ARMv7-M Architecture Reference Manual</a>, Appendix D4.
</p>
</div>

<div id="outline-container-org23255d2" class="outline-3">
<h3 id="org23255d2"><span class="section-number-3">1.1</span> Features</h3>
<div class="outline-text-3" id="text-1-1">
<p>
The framework is split into three main components: the canonical backend, the frontend(s), and the target-side tracing crate, <code>cortex-m-rtic-trace</code>.
</p>

<dl class="org-dl">
<dt>The backend</dt><dd>is a host-side (i.e., the system that programs the target device) application which exposes two operations:
<dl class="org-dl">
<dt><code>trace</code></dt><dd>where the target is flashed with the wanted firmware and the execution trace is captured and saved to file.</dd>
<dt><code>replay</code></dt><dd>where previously recorded traces are replayed for postmortem and offline analysis.</dd>
</dl></dd>
<dt>Frontend(s)</dt><dd><p>
While tracing and replaying, a trace can be forwarded to a set of frontends via Unix domain sockets where virtually endless analytics can be applied.
Consider, for example, a graphical frontend alike an oscilloscope or a logic analyzer, but instead of signals the RTIC tasks and their executation statuses (running, scheduled, preempted) are plotted.
A dummy frontend (used for debug and reference purposes) is available out of the box;
the dummy frontend prints received events, their absolute timestamps, and the time since the last chunk of events.
For example:
</p>
<div class="org-src-container">
<pre class="src src-fundamental">dummy: @1625485615052692868 ns (+124999937 ns): [] # the local timestamp clock overflowed, but nothing else happened
dummy: @1625485615052769556 ns (+76688 ns): [Task { name: "app::toggle", action: Entered }]
dummy: @1625485615052790806 ns (+21250 ns): [Task { name: "app::toggle", action: Exited }]
</pre>
</div>

<p>
At present, information only flows from the backend to the specified frontend, via <code>--frontend</code>.
In the future, bidirectional communication will be possible, enabling a frontend to implement a complex hardware-in-the-loop testing suite, for example.
Please refer to the <a href="#orgcdb179d">project roadmap</a> for future prospects.
</p></dd>
<dt>The target-side tracing crate</dt><dd><code>cortex-m-rtic-trace</code>, is a small auxiliary crate applied to the target application under trace.
It only exposes the <code>#[trace]</code> macro, which is used to trace RTIC software tasks.
NOTE: While hardware tasks are traced "free of charge" (see <a href="#org734dc17">5</a>), software tasks are traced by writing to a <code>u32</code>-variable twice.</dd>
</dl>
</div>
</div>

<div id="outline-container-org5995860" class="outline-3">
<h3 id="org5995860"><span class="section-number-3">1.2</span> Project repositories/crates</h3>
<div class="outline-text-3" id="text-1-2">
<p>
The framework is managed under the <a href="https://github.com/rtic-scope">RTIC Scope organization on GitHub</a>.
Below is a list of the main repositories that constitute the RTIC Scope project.
Any other crates listed under the organization but not here are branches of other repositories pending upstream merge.
</p>

<dl class="org-dl">
<dt><a href="https://github.com/rtic-scope/cargo-rtic-scope">cargo-rtic-scope</a></dt><dd>The RTIC Scope backend which builds the target application, recovers trace information, traces the target, replays traces, etc.</dd>
<dt><a href="https://github.com/rtic-scope/cortex-m-rtic-trace">cortex-m-rtic-trace</a></dt><dd><code>no_std</code> crate used to configure the target device for tracing purposes.</dd>
<dt><a href="https://github.com/rtic-scope/examples">examples</a></dt><dd>A set of example target applications where the RTIC Scope framework is applied. These are also <a href="#org718b105">documented below</a>.</dd>
<dt><a href="https://github.com/rtic-scope/api">api</a></dt><dd>The common API used between the RTIC Scope backend and all frontends.</dd>
<dt><a href="https://github.com/rtic-scope/frontend-dummy">frontend-dummy</a></dt><dd>A "noop" frontend implementation that writes received <code>api::EventChunk</code> structs to stderr with nanosecond timestamp information.</dd>
<dt><a href="https://github.com/rtic-scope/itm-decode">itm-decode</a></dt><dd>A host-side library that decodes the binary trace stream received from the target to workable Rust structures.</dd>
<dt><a href="https://github.com/rtic-scope/rfcs">rfcs</a></dt><dd>A catch-all meta-repository for discussions and feature suggestions that that encompass more than a single repository.</dd>
<dt><a href="https://github.com/rtic-scope/rtic-scope.github.io">rtic-scope.github.io</a></dt><dd>The source code for this web page.</dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-orgd01f69e" class="outline-2">
<h2 id="orgd01f69e"><span class="section-number-2">2</span> Requirements</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org4803f03" class="outline-3">
<h3 id="org4803f03"><span class="section-number-3">2.1</span> Hardware</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>A target device with an ARMv7-M MCU.</li>
<li>A hardware probe supported by <code>probe-rs</code> <i>or</i> some serial hardware that exposes a serial device which then can be used to read the trace stream from the target device.</li>
</ul>
</div>
</div>

<div id="outline-container-org003680d" class="outline-3">
<h3 id="org003680d"><span class="section-number-3">2.2</span> Software</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>A Linux-based operating system with a recent Rust toolchain. Minimum supported Rust version TBA.</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org09be389" class="outline-2">
<h2 id="org09be389"><span class="section-number-2">3</span> Getting started</h2>
<div class="outline-text-2" id="text-3">
<p>
Install the backend and reference frontend via
</p>
<div class="org-src-container">
<pre class="src src-fundamental">$ cargo install --git https://github.com/rtic-scope/cargo-rtic-scope.git
$ cargo install rtic-scope-frontend-dummy
</pre>
</div>
</div>

<div id="outline-container-org718b105" class="outline-3">
<h3 id="org718b105"><span class="section-number-3">3.1</span> Examples</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-org25b2532" class="outline-4">
<h4 id="org25b2532"><span class="section-number-4">3.1.1</span> blinky</h4>
<div class="outline-text-4" id="text-3-1-1">
<p>
Assuming you have a STM32F401 Nucleo-64 at hand, let us get a trace from a simple blinking LED application:
</p>
<div class="org-src-container">
<pre class="src src-fundamental">$ git clone https://github.com/rtic-scope/examples.git &amp;&amp; cd examples
$ cargo rtic-scope trace --bin blinky-noconf --chip stm32f401re --clear-traces --tpiu-freq 16000000
"cargo" "build" "--bin" "blinky-noconf" "--message-format=json"
   Compiling trace-examples v0.1.0 (/home/tmplt/exjobb/trace-examples)
    Finished dev [unoptimized + debuginfo] target(s) in 1.88s
warning: unused import: `trace`
  --&gt; src/bin/blinky-noconf.rs:10:37
   |
10 |     use cortex_m_rtic_trace::{self, trace};
   |                                     ^^^^^
   |
   = note: `#[warn(unused_imports)]` on by default

warning: unused import: `cortex_m::asm`
  --&gt; src/bin/blinky-noconf.rs:12:9
   |
12 |     use cortex_m::asm;
   |         ^^^^^^^^^^^^^

warning: variable does not need to be mutable
  --&gt; src/bin/blinky-noconf.rs:20:13
   |
20 |     fn init(mut ctx: init::Context) -&gt; (init::LateResources, init::Monotonics) {
   |             ----^^^
   |             |
   |             help: remove this `mut`
   |
   = note: `#[warn(unused_mut)]` on by default

warning: 3 warnings emitted

Flashing /home/tmplt/exjobb/trace-examples/target/thumbv7em-none-eabihf/debug/blinky-noconf...
Flashed.
Resetting target...
Reset.
exceptions:
	 SysTick -&gt; ["app", "toggle"]
interrupts:
software tasks:

reset timestamp: 2021-07-05 13:46:53.931431868 +02:00
trace clock frequency: 16000000 Hz

Buffer size of source could not be found. Buffer may overflow and corrupt trace stream without warning.
Failed to resolve chunk from TimestampedTracePackets { timestamp: Timestamp { base: None, delta: Some(1940184), data_relation: Some(Sync), diverged: false }, packets: [ExceptionTrace { exception: ThreadMode, action: Entered }] }. Reason: Don't know what to do with ThreadMode. Ignoring...
Don't know how to convert Sync. Skipping...
Don't know how to convert Sync. Skipping...
Don't know how to convert Sync. Skipping...
Don't know how to convert Sync. Skipping...
^Cdummy: @1625485614177693306 ns (+1625485614177693306 ns): []
dummy: @1625485614302693243 ns (+124999937 ns): []
dummy: @1625485614427693181 ns (+124999938 ns): []
dummy: @1625485614552693118 ns (+124999937 ns): []
dummy: @1625485614677693056 ns (+124999938 ns): []
dummy: @1625485614802692993 ns (+124999937 ns): []
dummy: @1625485614927692931 ns (+124999938 ns): []
dummy: @1625485615052692868 ns (+124999937 ns): []
dummy: @1625485615052769556 ns (+76688 ns): [Task { name: "app::toggle", action: Entered }]
dummy: @1625485615052790806 ns (+21250 ns): [Task { name: "app::toggle", action: Exited }]
dummy: @1625485615177790743 ns (+124999937 ns): []
dummy: @1625485615302790681 ns (+124999938 ns): []
dummy: @1625485615427790618 ns (+124999937 ns): []
dummy: @1625485615552790556 ns (+124999938 ns): []
dummy: @1625485615677790493 ns (+124999937 ns): []
dummy: @1625485615802790431 ns (+124999938 ns): []
dummy: @1625485615927790368 ns (+124999937 ns): []
dummy: @1625485616052768868 ns (+124978500 ns): [Task { name: "app::toggle", action: Entered }]
dummy: @1625485616052790181 ns (+21313 ns): [Task { name: "app::toggle", action: Exited }]
dummy: @1625485616177790118 ns (+124999937 ns): []
dummy: @1625485616302790056 ns (+124999938 ns): []
dummy: @1625485616427789993 ns (+124999937 ns): []
dummy: @1625485616552789931 ns (+124999938 ns): []
dummy: @1625485616677789868 ns (+124999937 ns): []
dummy: @1625485616802789806 ns (+124999938 ns): []
dummy: @1625485616927789743 ns (+124999937 ns): []
dummy: @1625485617052768368 ns (+124978625 ns): [Task { name: "app::toggle", action: Entered }]
dummy: @1625485617052789618 ns (+21250 ns): [Task { name: "app::toggle", action: Exited }]
dummy: @1625485617177789556 ns (+124999938 ns): []
dummy: @1625485617302789493 ns (+124999937 ns): []
dummy: @1625485617427789431 ns (+124999938 ns): []
dummy: @1625485617552789368 ns (+124999937 ns): []
</pre>
</div>

<p>
Now, let us list and replay the trace we just recorded:
</p>
<div class="org-src-container">
<pre class="src src-fundamental">$ cargo rtic-scope replay --bin blinky-noconf --list
0       /home/tmplt/exjobb/trace-examples/target/rtic-traces/blinky-noconf-ge9d44c3-2021-07-05T13:46:53.trace
$ cargo rtic-scope replay 0 --bin blinky-noconf
Replaying /home/tmplt/exjobb/trace-examples/target/rtic-traces/blinky-noconf-ge9d44c3-2021-07-05T13:46:53.trace
exceptions:
	 SysTick -&gt; ["app", "toggle"]
interrupts:
software tasks:

reset timestamp: 2021-07-05 13:46:53.931431868 +02:00
trace clock frequency: 16000000 Hz

Failed to resolve chunk from TimestampedTracePackets { timestamp: Timestamp { base: None, delta: Some(1940184), data_relation: Some(Sync), diverged: false }, packets: [ExceptionTrace { exception: ThreadMode, action: Entered }] }. Reason: Don't know what to do with ThreadMode. Ignoring...
Don't know how to convert Sync. Skipping...
Don't know how to convert Sync. Skipping...
Don't know how to convert Sync. Skipping...
Don't know how to convert Sync. Skipping...
dummy: @1625485614177693306 ns (+1625485614177693306 ns): []
dummy: @1625485614302693243 ns (+124999937 ns): []
dummy: @1625485614427693181 ns (+124999938 ns): []
dummy: @1625485614552693118 ns (+124999937 ns): []
dummy: @1625485614677693056 ns (+124999938 ns): []
dummy: @1625485614802692993 ns (+124999937 ns): []
dummy: @1625485614927692931 ns (+124999938 ns): []
dummy: @1625485615052692868 ns (+124999937 ns): []
dummy: @1625485615052769556 ns (+76688 ns): [Task { name: "app::toggle", action: Entered }]
dummy: @1625485615052790806 ns (+21250 ns): [Task { name: "app::toggle", action: Exited }]
dummy: @1625485615177790743 ns (+124999937 ns): []
dummy: @1625485615302790681 ns (+124999938 ns): []
dummy: @1625485615427790618 ns (+124999937 ns): []
dummy: @1625485615552790556 ns (+124999938 ns): []
dummy: @1625485615677790493 ns (+124999937 ns): []
dummy: @1625485615802790431 ns (+124999938 ns): []
dummy: @1625485615927790368 ns (+124999937 ns): []
dummy: @1625485616052768868 ns (+124978500 ns): [Task { name: "app::toggle", action: Entered }]
dummy: @1625485616052790181 ns (+21313 ns): [Task { name: "app::toggle", action: Exited }]
dummy: @1625485616177790118 ns (+124999937 ns): []
dummy: @1625485616302790056 ns (+124999938 ns): []
dummy: @1625485616427789993 ns (+124999937 ns): []
dummy: @1625485616552789931 ns (+124999938 ns): []
dummy: @1625485616677789868 ns (+124999937 ns): []
dummy: @1625485616802789806 ns (+124999938 ns): []
dummy: @1625485616927789743 ns (+124999937 ns): []
dummy: @1625485617052768368 ns (+124978625 ns): [Task { name: "app::toggle", action: Entered }]
dummy: @1625485617052789618 ns (+21250 ns): [Task { name: "app::toggle", action: Exited }]
dummy: @1625485617177789556 ns (+124999938 ns): []
dummy: @1625485617302789493 ns (+124999937 ns): []
dummy: @1625485617427789431 ns (+124999938 ns): []
dummy: @1625485617552789368 ns (+124999937 ns): []
</pre>
</div>

<p>
We can read from the <code>dummy</code> frontend that toggling a LED takes about 21µs in debug mode.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd283a18" class="outline-2">
<h2 id="orgd283a18"><span class="section-number-2">4</span> Concepts</h2>
<div class="outline-text-2" id="text-4">
<dl class="org-dl">
<dt>Source</dt><dd>a (trace) <b>source</b> is any implementation of <a href="https://github.com/rtic-scope/cargo-rtic-scope/blob/master/src/sources/mod.rs#L20"><code>trait Source</code></a> from which decoded trace packets can be pulled via <code>Iterator::next</code>.
A source can be a live target via <code>DAPSource</code> (e.g. an STLink), <code>TTYSource</code> (i.e. a <code>/dev/tty*</code> device), or a file on disk via <code>FileSource</code>.</dd>
<dt>Sink</dt><dd>a (trace) <b>sink</b> is any implementation of <code>trait Sink</code> to which decoded trace packets can be <a href="https://github.com/rtic-scope/cargo-rtic-scope/blob/master/src/sinks/mod.rs"><code>Sink::drain</code></a>ed (alt. "forwarded").
A sink can be a file on disk via <code>FileSink</code> or a frontend via <code>FrontendSink</code>.</dd>
</dl>

<p>
<code>cargo-rtic-scope</code> abstracts its operation by utilizing a single source and set of sinks.
After these have been contructed along with the <a href="#orgc999d7b">trace metadata</a>, packets are continously read from the source and forwarded to all sinks.
If a sink breaks (i.e. <code>Sink::drain</code> yields <code>Err</code>) the user is warned.
If all sinks break, cargo exits with non-zero.
If at least one sink is available, <code>cargo-rtic-scope</code> continues to trace/replay until <code>Source::next</code> yields <code>None</code> or <code>Some(Err)</code>, or until a SIGINT signal is received.
</p>
</div>
</div>

<div id="outline-container-org734dc17" class="outline-2">
<h2 id="org734dc17"><span class="section-number-2">5</span> How it works</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org8d2d853" class="outline-3">
<h3 id="org8d2d853"><span class="section-number-3">5.1</span> The ITM/DWT subsystem</h3>
<div class="outline-text-3" id="text-5-1">
<p>
A stream of back-to-back ITM packets are read from a target or a file.
Each packet contains a header and a number of payload bytes.
Of special interest are exception trace packets:
</p>
<blockquote>
<p>
The DWT unit can generate an Exception trace packet whenever then processor enters, exits, or returns to an exception.
&#x2014; Appendix D4.3.2
</p>
</blockquote>
<p>
This packet then contains one of the exception numbers listed in the table below.
These numbers are bound to RTIC tasks.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="all" frame="hsides">
<caption class="t-above"><span class="table-number">Table 1:</span> ARMv7-M Exception numbers</caption>

<colgroup>
<col  class="org-right" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">Exception number</th>
<th scope="col" class="org-left">Exception name/label</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">Reset</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">NMI</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">HardFault</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">MemManage</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">BusFault</td>
</tr>

<tr>
<td class="org-right">7-10</td>
<td class="org-left">Reserved</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">SVCall</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-left">DebugMonitor</td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">Reserved</td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-left">PendSV</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">SysTick</td>
</tr>

<tr>
<td class="org-right">16</td>
<td class="org-left">External interrupt 0</td>
</tr>

<tr>
<td class="org-right">.</td>
<td class="org-left">.</td>
</tr>

<tr>
<td class="org-right">.</td>
<td class="org-left">.</td>
</tr>

<tr>
<td class="org-right">.</td>
<td class="org-left">.</td>
</tr>

<tr>
<td class="org-right">16 + N</td>
<td class="org-left">External interrupt N</td>
</tr>
</tbody>
</table>

<p>
Henceforth, this document will refer to these exceptions/interrupt numbers as interrupt request (IRQ) numbers.
</p>

<p>
Software tasks are similarly traced, but come at a cost of a write to a <code>u32</code> variable when entering and exiting the task, resulting in a cost of two writes.
This variable is registered as a watch address in the DWT subsystem.
Any writes to this address are asynchronously intercepted in hardware, and the new value is encapsulated in an ITM packet along with the ID of the DWT comparator.
</p>
</div>
</div>

<div id="outline-container-orgc999d7b" class="outline-3">
<h3 id="orgc999d7b"><span class="section-number-3">5.2</span> Host-side information recovery</h3>
<div class="outline-text-3" id="text-5-2">
<p>
The received IRQ numbers in a packet must be associated back to the correct RTIC tasks.
This is done in a preparatory step before the target is flashed and traced.
For example, when executing <code>cargo rtic-scope --bin blinky [options]</code>:
</p>
<ol class="org-ol">
<li><code>blinky</code> is build via a regular <code>cargo build --bin blinky</code>.</li>
<li><p>
The RTIC application declaration, <code>#[app(...)] mod app {...}</code>, is parsed from <code>blinky</code>'s source code.
From this declaration, the <code>#[app(device = ...)]</code> argument is extracted along with the IRQ label from each <code>#[task(binds = ...)]</code> macro occurance.
Additionally, software tasks traced using the <code>#[trace]</code> macro are enumerated and mapped.
For example, <code>device = stm32f4::stm32f401</code>, <code>binds = SysTick</code>, and <code>binds = EXTI1</code> might be extracted.
Here, each IRQ label is associated with the RTIC task it is bound to.
</p>

<p>
This parsing step places some restrictions on how the source code for an RTIC application can be written. Refer to <a href="#orge366da9">6.2</a>.
</p></li>
<li><p>
An shared object file is then built which translates IRQ labels to IRQ numbers.
The source code for this object will look like the following with the information from the previous step:
</p>
<div class="org-src-container">
<pre class="src src-rust">use stm32f4::stm32f401::Interrupt;

// Only external interrupts need be written here.
// Exceptions-bound tasks are resolved using the table above.

#[no_mangle]
pub extern fn rtic_scope_func_EXTI1() -&gt; u8 {
    Interrupt::EXTI1.nr()
}
</pre>
</div>
<p>
After loading the resultant shared library and calling all functions, a <code>IRQ number -&gt; IRQ label -&gt; RTIC task</code> map ("task map") is yielded.
</p></li>
</ol>

<p>
Along with the task map, an absolute timestamp is also calculated for each set of trace packets received.
This is done by sampling the time just before the target is reset and applying an offset based upon the trace clock frequency and local/global timestamps received over ITM.
This frequency can be set via <code>--tpiu-freq</code>.
If not set, a <code>DataTraceValue</code> with a non-zero 4B payload is expected in the trace and interpreted as a <code>u32</code> representation of the trace clock frequency.
Only the first packet of this type is intercepted and consumed.
</p>

<p>
This <code>(task map, reset timestamp, trace clock frequency)</code> tuple constitutes the metadata of a trace, and is saved as a header to all trace files.
</p>
</div>
</div>
</div>

<div id="outline-container-org9ce4b4a" class="outline-2">
<h2 id="org9ce4b4a"><span class="section-number-2">6</span> Limitations</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-org9a06bec" class="outline-3">
<h3 id="org9a06bec"><span class="section-number-3">6.1</span> Dropped ITM packets</h3>
<div class="outline-text-3" id="text-6-1">
<p>
If the input buffer of the serial device is filled, packets will be lost or corrupted.
A warning will be printed before this buffer is overflowed, or if the buffer size cannot be determined.
</p>
</div>
</div>

<div id="outline-container-orge366da9" class="outline-3">
<h3 id="orge366da9"><span class="section-number-3">6.2</span> RTIC application constrains</h3>
<div class="outline-text-3" id="text-6-2">
<p>
At present, the <code>device</code> argument of the RTIC app macro, i.e. <code>#[app(device = stm32f4::stm32f401, ...)]</code>, is interpreted as a crate name and feature combination.
In this example, <code>stm32f4</code> is interpreted as the crate name, and <code>stm32f401</code> as the crate feature when recovering information.
Additionally, the <code>Interrupt</code> enum of this peripheral access crate is expected at <code>stm32f4::stm32f401::Interrupt</code>.
<a href="https://github.com/rtic-scope/cargo-rtic-scope/issues/22">This contraint is planned to be lifted</a>.
See <a href="https://github.com/rtic-scope/examples/blob/master/src/bin/blinky-noconf.rs">the examples</a> for how to write an RTIC Scope-compliant application.
</p>
</div>
</div>

<div id="outline-container-orgc0e924f" class="outline-3">
<h3 id="orgc0e924f"><span class="section-number-3">6.3</span> Target-side overhead</h3>
<div class="outline-text-3" id="text-6-3">
<ul class="org-ul">
<li>If <code>--tpiu-freq</code> is not set, it is up to the target application to wholly configure tracing and send the correct trace clock frequency value.
See <a href="https://github.com/rtic-scope/cargo-rtic-scope/issues/20">#20</a>.</li>
<li>When tracing software tasks:
<ul class="org-ul">
<li>a DWT comparator must be effectively consumed.
Additionally, the ID of the comparator must be communicated to the backend by writing the value to a watch address.</li>
<li>When entering/exiting a software task marked for tracing, a <code>u8</code> (at minimum) must be written to a watch addess;
a <code>u32</code> in the worst case (depending on the number of tracing software tasks<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>).</li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgc6d88e7" class="outline-2">
<h2 id="orgc6d88e7"><span class="section-number-2">7</span> Frequently asked questions</h2>
<div class="outline-text-2" id="text-7">
<dl class="org-dl">
<dt>Where are all build artifacts stored?</dt><dd><p>
Most likely under <code>target/</code>, assuming the current working directory is a crate containing target applications.
The target directory can be overridden via the environmental variable <code>TARGET_DIR</code> or the <code>--target-dir</code> option.
Note that the RTIC application will be rebuilt to this location.
</p>

<p>
<code>cargo-rtic-scope</code> also respects <a href="https://doc.rust-lang.org/cargo/reference/config.html">Cargo's configuration system</a>.
</p></dd>
<dt>Where are all traces saved to?</dt><dd><p>
Recorded traces are serialized to JSON and saved to <code>/path/to/target-dir/rtic-traces</code>, which means <code>target/rtic-traces</code> by default.
This directory can be overridden via the <code>--trace-dir</code> option.
The same option  is used to replay traces located in a non-default location.
</p>

<p>
<b>NOTE:</b> any traces saved to the target directory will be lost on a <code>cargo clean</code>.
</p></dd>
</dl>
</div>
</div>

<div id="outline-container-orgcdb179d" class="outline-2">
<h2 id="orgcdb179d"><span class="section-number-2">8</span> Roadmap</h2>
<div class="outline-text-2" id="text-8">
<p>
The milestone for a minimum viable product (MVP) has been reached as of <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-07-06 Tue&gt;</span></span>!
This MVP only traces hardware tasks; software task tracing is not yet fully implemented.
</p>

<p>
<a href="https://github.com/rtic-scope/cargo-rtic-scope/milestone/2">Another milestone has been defined for a first stable release</a>.
</p>
</div>
</div>

<div id="outline-container-orgc79ca6f" class="outline-2">
<h2 id="orgc79ca6f"><span class="section-number-2">9</span> Known issues (of note)</h2>
<div class="outline-text-2" id="text-9">
<ul class="org-ul">
<li>Usage of an STLink probe source is not stable. (<a href="https://github.com/rtic-scope/cargo-rtic-scope/issues/18">#18</a>)</li>
<li>Arguments to cargo are not forwarded. (<a href="https://github.com/rtic-scope/cargo-rtic-scope/issues/9">#9</a>)</li>
</ul>

<p>
<a href="https://github.com/rtic-scope/cargo-rtic-scope/issues">See the issue tracker for all known issues</a>.
</p>
</div>
</div>

<div id="outline-container-org11b152c" class="outline-2">
<h2 id="org11b152c"><span class="section-number-2">10</span> Publications</h2>
<div class="outline-text-2" id="text-10">
<p>
TBA
</p>
</div>
</div>

<div id="outline-container-org55797e3" class="outline-2">
<h2 id="org55797e3"><span class="section-number-2">11</span> License</h2>
<div class="outline-text-2" id="text-11">
<p>
For non-commercial purposes, RTIC Scope is licensed under both the MIT Licence and the Apache License (Version 2.0).
For commercial support and alternative licensing, inquire via <a href="mailto:contact@grepit.se">&lt;contact@grepit.se&gt;</a>.
</p>

<p>
RTIC Scope is maintained in cooperation with Grepit AB and Luleå Technical University, Sweden.
</p>
</div>
</div>

<div id="outline-container-orgdb876a4" class="outline-2">
<h2 id="orgdb876a4"><span class="section-number-2">12</span> Contact, bug reports and contributions</h2>
<div class="outline-text-2" id="text-12">
<p>
Bug reports and contributions are welcome. Please file it under the <a href="#org5995860">relevant repository</a>.
</p>

<p>
Project maintainer can be reached via email at <a href="mailto:v@tmplt.dev">&lt;v@tmplt.dev&gt;</a>.
</p>

<hr />
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
The overhead will be <code>u8</code> unless your application has more than 256 software tasks.
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Viktor Vilhelm Sonesten</p>
<p class="date">Created: 2021-07-24 Sat 00:12</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
